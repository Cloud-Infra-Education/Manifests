name: Validate Kubernetes Manifests

on:
  push:
    branches:
      - main
      - 'feat/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Manifests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: 'v5.1.1'

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” YAML ë¬¸ë²• ê²€ì¦ ì‹œìž‘..."
          find . -name "*.yaml" -o -name "*.yml" | grep -v node_modules | while read file; do
            echo "ê²€ì¦ ì¤‘: $file"
            # UTF-8 ì¸ì½”ë”© ëª…ì‹œ ë° BOM ì œê±°
            python3 -c "
            import yaml
            import sys
            try:
              with open('$file', 'r', encoding='utf-8', errors='replace') as f:
                content = f.read()
                # BOM ì œê±°
                if content.startswith('\ufeff'):
                  content = content[1:]
                yaml.safe_load(content)
            except UnicodeDecodeError as e:
              print(f'âŒ ì¸ì½”ë”© ì˜¤ë¥˜: $file')
              print(f'   ì˜¤ë¥˜: {e}')
              sys.exit(1)
            except yaml.YAMLError as e:
              print(f'âŒ YAML ë¬¸ë²• ì˜¤ë¥˜: $file')
              print(f'   ì˜¤ë¥˜: {e}')
              sys.exit(1)
            " || exit 1
          done
          echo "âœ… YAML ë¬¸ë²• ê²€ì¦ ì™„ë£Œ"

      - name: Validate Kubernetes manifests with kubeval
        uses: instrumenta/kubeval-action@master
        with:
          files: |
            base/**/*.yaml
            seoul/**/*.yaml
          kubeval-version: latest
          strict: true
          skip-kinds: |
            CustomResourceDefinition
        continue-on-error: false

      - name: Build with kustomize (base)
        working-directory: ./base
        run: |
          echo "ðŸ”¨ base ë””ë ‰í† ë¦¬ kustomize ë¹Œë“œ..."
          kustomize build . > /tmp/base-built.yaml
          echo "âœ… base ë¹Œë“œ ì™„ë£Œ"

      - name: Build with kustomize (seoul)
        working-directory: ./seoul
        run: |
          echo "ðŸ”¨ seoul ë””ë ‰í† ë¦¬ kustomize ë¹Œë“œ..."
          kustomize build . > /tmp/seoul-built.yaml || echo "âš ï¸ seoul ë””ë ‰í† ë¦¬ ë¹Œë“œ ì‹¤íŒ¨ (ì„ íƒì‚¬í•­)"
          echo "âœ… seoul ë¹Œë“œ ì™„ë£Œ"

      - name: Validate built manifests
        run: |
          echo "ðŸ” ë¹Œë“œëœ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ê²€ì¦..."
          if [ -f /tmp/base-built.yaml ]; then
            kubectl --dry-run=client -f /tmp/base-built.yaml apply > /dev/null 2>&1 || echo "âš ï¸ ì¼ë¶€ ë¦¬ì†ŒìŠ¤ëŠ” dry-runì—ì„œ ì‹¤íŒ¨í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ (ì •ìƒ)"
          fi
          echo "âœ… ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ê²€ì¦ ì™„ë£Œ"

      - name: Check for hardcoded secrets
        run: |
          echo "ðŸ” í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬..."
          if grep -r "password\|secret\|key\|token" --include="*.yaml" --include="*.yml" base/ | grep -v "kind:\|name:\|type:\|namespace:\|apiVersion:" | grep -i ":\s*[A-Za-z0-9+/=]\{20,\}" | grep -v "#"; then
            echo "âš ï¸ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê°€ëŠ¥ì„±ì´ ìžˆìŠµë‹ˆë‹¤. Secret ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
          else
            echo "âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì—†ìŒ"
          fi

      - name: Security scan with trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Summary
        run: |
          echo "## âœ… ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- YAML ë¬¸ë²• ê²€ì¦: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Kubernetes ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ê²€ì¦: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- kustomize ë¹Œë“œ: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- ë³´ì•ˆ ìŠ¤ìº”: âœ…" >> $GITHUB_STEP_SUMMARY
